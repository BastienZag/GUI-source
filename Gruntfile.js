'use strict';

//--------------------------------------------------------------------------------------------------------------------------------------------------------------
//
//                                     ██████╗  ██╗   ██╗ ██╗       ███████╗  ██████╗  ██╗   ██╗ ██████╗   ██████╗ ███████╗
//                                    ██╔════╝  ██║   ██║ ██║       ██╔════╝ ██╔═══██╗ ██║   ██║ ██╔══██╗ ██╔════╝ ██╔════╝
//                                    ██║  ███╗ ██║   ██║ ██║       ███████╗ ██║   ██║ ██║   ██║ ██████╔╝ ██║      █████╗
//                                    ██║   ██║ ██║   ██║ ██║       ╚════██║ ██║   ██║ ██║   ██║ ██╔══██╗ ██║      ██╔══╝
//                                    ╚██████╔╝ ╚██████╔╝ ██║       ███████║ ╚██████╔╝ ╚██████╔╝ ██║  ██║ ╚██████╗ ███████╗
//                                     ╚═════╝   ╚═════╝  ╚═╝       ╚══════╝  ╚═════╝   ╚═════╝  ╚═╝  ╚═╝  ╚═════╝ ╚══════╝
//                                                                       Created by Westpac digital
// @desc     GUI source code for testing and maintance
// @author   Dominik Wilkowski
// @website  https://github.com/WestpacCXTeam/GUI-source
// @issues   https://github.com/WestpacCXTeam/GUI-source/issues
//--------------------------------------------------------------------------------------------------------------------------------------------------------------


//--------------------------------------------------------------------------------------------------------------------------------------------------------------
// External dependencies
//--------------------------------------------------------------------------------------------------------------------------------------------------------------
var fs = require('fs');
var path = require('path');


//--------------------------------------------------------------------------------------------------------------------------------------------------------------
// Grunt module
//--------------------------------------------------------------------------------------------------------------------------------------------------------------
module.exports = function(grunt) {


	//------------------------------------------------------------------------------------------------------------------------------------------------------------
	// Dependencies
	//------------------------------------------------------------------------------------------------------------------------------------------------------------
	grunt.loadNpmTasks('grunt-auto-install');
	grunt.loadNpmTasks('grunt-text-replace');
	grunt.loadNpmTasks('grunt-font');
	grunt.loadNpmTasks('grunt-wakeup');


	//------------------------------------------------------------------------------------------------------------------------------------------------------------
	// Custom grunt task to create list index
	//------------------------------------------------------------------------------------------------------------------------------------------------------------
	grunt.registerTask('buildIndex', 'Build an index html file to mapp all modules for gh-pages.', function() {

		var replace = {};
		var replaceStr = '';
		var GUI = {};

		grunt.file.expand({ filter: 'isDirectory' }, [
			'./*',
			'!./node_modules',
			'!./._templates',
			'!./.git',
		]).forEach(function(dir) {

			var module = dir.substr( dir.lastIndexOf('/') + 1 );

			GUI[ module ] = {
				'name': module,
				'versions': {},
			};

			replaceStr += '<li>';

			grunt.file.expand({ filter: 'isDirectory' }, [dir + '/*']).forEach(function(subdir) {

				var version = subdir.substr( subdir.lastIndexOf('/') + 1 );

				if( version !== 'node_modules' ) {
					//add versioning to files
					replaceStr += '<h2>' + module + '</h2>' +
						'<ul>' +
						'	<li>' +
						'		<h3>v' + version + '</h3>' +
						'		<ul>' +
						'			<li><a href="' + subdir + '/_tests/BOM/">BOM</a></li>' +
						'			<li><a href="' + subdir + '/_tests/BSA/">BSA</a></li>' +
						'			<li><a href="' + subdir + '/_tests/STG/">STG</a></li>' +
						'			<li><a href="' + subdir + '/_tests/WBC/">WBC</a></li>' +
						'		</ul>' +
						'	</li>' +
						'</ul>';

					GUI[ module ].versions[version] = module + '/' + version + '/';
				}
			});

			replaceStr += '</li>';

		});


		grunt.file.write('./GUI.json', JSON.stringify(GUI));


		replace[ 'Replace' ] = {
			src: [
				'./._template/index/index.html',
			],
			dest: './index.html',
			overwrite: false,
			replacements: [{
				from: '[Modules]',
				to: replaceStr,
			}],
		};


		//running tasks
		grunt.config.set('replace', replace);
		grunt.task.run('replace');
	});


	//------------------------------------------------------------------------------------------------------------------------------------------------------------
	// Custom grunt task to create list index
	//------------------------------------------------------------------------------------------------------------------------------------------------------------
	grunt.registerTask('npmInstall', 'Install all npm dependencies.', function() {

		var auto_install = {};

		grunt.file.expand({ filter: 'isDirectory' }, [
			'./*',
			'!./node_modules',
			'!./._templates',
			'!./.git',
		]).forEach(function(dir) {

			auto_install[ 'Install' + dir ] = {
				options: {
					cwd: dir,
					stdout: true,
					stderr: true,
					failOnError: true,
					npm: true,
					bower: false,
				},
			};

		});

		//running tasks
		grunt.config.set('auto_install', auto_install);
		grunt.task.run('auto_install');
	});


	//------------------------------------------------------------------------------------------------------------------------------------------------------------
	// Grunt tasks
	//------------------------------------------------------------------------------------------------------------------------------------------------------------
	grunt.initConfig({


		//----------------------------------------------------------------------------------------------------------------------------------------------------------
		// Banner
		//----------------------------------------------------------------------------------------------------------------------------------------------------------
		font: {
			options: {
				space: false,
				maxLength: 11,
				colors: ['white', 'gray'],
			},

			title: {
				text: '| GUI SOURCE',
			},
		},


		//----------------------------------------------------------------------------------------------------------------------------------------------------------
		// Wakeup
		//----------------------------------------------------------------------------------------------------------------------------------------------------------
		wakeup: {
			wakeme: {
				options: {
					randomize: true,
				},
			},
		},

	});



	//------------------------------------------------------------------------------------------------------------------------------------------------------------
	// Build tasks
	//------------------------------------------------------------------------------------------------------------------------------------------------------------
	grunt.registerTask('default', [
		'font',
		'buildIndex',
		'wakeup',
	]);

	grunt.registerTask('install', [
		'font',
		'npmInstall',
		'wakeup',
	]);

};